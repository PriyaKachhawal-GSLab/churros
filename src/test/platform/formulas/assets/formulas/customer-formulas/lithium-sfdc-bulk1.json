{
    "id": 19147,
    "name": "bulk1sfdc",
    "userId": 485,
    "accountId": 1937,
    "createdDate": "2018-01-03T20:44:08Z",
    "steps": [
      {
        "id": 99840,
        "onSuccess": [
          "postBulk"
        ],
        "onFailure": [],
        "name": "bulkHeader",
        "type": "script",
        "properties": {
          "body": "var obj = steps.returnId;\n\ndone({'Elements-Async-Callback-Url' : '/formulas/instances/'+obj.formulaInstance2+'/executions'});"
        }
      },
      {
        "id": 99839,
        "onSuccess": [
          "bulkHeader"
        ],
        "onFailure": [],
        "name": "bulkQuery",
        "type": "script",
        "properties": {
          "body": "var fieldString = steps['return-transformation'].query;\nvar obj = steps.returnId;\n\nif(config.lastruntime === null || config.lastruntime === undefined || config.lastruntime === \"\" || config.lastruntime == \"none\"){\n  done( { \"q\" : \"select \" + fieldString + \" from Contact\",\n          \"to\" : obj.newendtime } );\n}\nelse{\n  done( { \"q\" : \"select \" + fieldString + \" from Contact\",\n          \"from\" : config.lastruntime,\n          \"to\" : obj.newendtime} );\n}\n"
        }
      },
      {
        "id": 99833,
        "onSuccess": [
          "formulaInstance"
        ],
        "onFailure": [],
        "name": "canRun",
        "type": "filter",
        "properties": {
          "body": "var run = config.canrun;\n\nif(run == \"yes\"){\n  done(true)\n}\nelse {\n  done(false)\n}"
        }
      },
      {
        "id": 99844,
        "onSuccess": [],
        "onFailure": [],
        "name": "failureNotification",
        "type": "script",
        "properties": {
          "body": "notify.email(config.email,'Error','There was an error');\ndone({});"
        }
      },
      {
        "id": 99835,
        "onSuccess": [
          "returnId"
        ],
        "onFailure": [
          "failureNotification"
        ],
        "name": "formulaInstance",
        "type": "request",
        "properties": {
          "api": "/formulas/instances",
          "retryAttempts": "5",
          "retryDelay": "500",
          "method": "GET",
          "retry": "true"
        }
      },
      {
        "id": 99837,
        "onSuccess": [
          "return-transformation"
        ],
        "onFailure": [
          "failureNotification"
        ],
        "name": "get-transformation",
        "type": "request",
        "properties": {
          "api": "/instances/{lithiumInstance}/transformations/sfdc_Contact_authorsBatch",
          "path": "${steps.returnId}",
          "method": "GET"
        }
      },
      {
        "id": 99841,
        "onSuccess": [
          "putBody"
        ],
        "onFailure": [
          "failureNotification"
        ],
        "name": "postBulk",
        "type": "elementRequest",
        "properties": {
          "elementInstanceId": "${sfdc.instance.id}",
          "api": "/hubs/crm/bulk/query",
          "retryAttempts": "5",
          "retryDelay": "500",
          "headers": "${steps.bulkHeader}",
          "query": "${steps.bulkQuery}",
          "method": "POST",
          "retry": "true"
        }
      },
      {
        "id": 99842,
        "onSuccess": [
          "putConfigs"
        ],
        "onFailure": [],
        "name": "putBody",
        "type": "script",
        "properties": {
          "body": "var obj = steps.returnId;\n\ndone({\"active\": obj.active,\n      \"name\": obj.instance1name,\n      \"configuration\": {\n        \"canrun\": \"no\",\n        \"lastruntime\": obj.lastruntime,  //this patches \"none\" if first run - patches last run's endtime if not first run\n        \"formulainstanceid\": obj.formulainstanceid,\n        \"endtime\": obj.newendtime,\n        \"sfdc.instance.id\": obj['sfdcinstanceid'],\n        \"email\":config.email\n        }\n      });"
        }
      },
      {
        "id": 99845,
        "onSuccess": [
          "putCanRun"
        ],
        "onFailure": [],
        "name": "putBodyCanRun",
        "type": "script",
        "properties": {
          "body": "var obj = steps.returnId;\n\ndone({\"active\" : obj.active,\n      \"configuration\": {\n        \"canrun\": \"no\",\n        \"lastruntime\": obj.lastruntime,  //this patches \"none\" if first run - patches last run's endtime if not first run\n        \"formulainstanceid\": obj.formulainstanceid,\n        \"endtime\": obj.endtime,\n        \"sfdc.instance.id\": obj['sfdcinstanceid'],\n        \"email\": config.email\n      },\n      \"name\":obj.instance1name});"
        }
      },
      {
        "id": 99836,
        "onSuccess": [
          "get-transformation"
        ],
        "onFailure": [
          "failureNotification"
        ],
        "name": "putCanRun",
        "type": "request",
        "properties": {
          "api": "/formulas/{formulaOneId}/instances/{formulainstanceid}",
          "retryAttempts": "5",
          "body": "${steps.putBodyCanRun}",
          "retryDelay": "500",
          "path": "${steps.returnId}",
          "method": "PUT",
          "retry": "true"
        }
      },
      {
        "id": 99843,
        "onSuccess": [],
        "onFailure": [
          "failureNotification"
        ],
        "name": "putConfigs",
        "type": "request",
        "properties": {
          "api": "/formulas/{formulaOneId}/instances/{formulainstanceid}",
          "retryAttempts": "5",
          "body": "${steps.putBody}",
          "retryDelay": "500",
          "path": "${steps.returnId}",
          "method": "PUT",
          "retry": "true"
        }
      },
      {
        "id": 99834,
        "onSuccess": [
          "putBodyCanRun"
        ],
        "onFailure": [],
        "name": "returnId",
        "type": "script",
        "properties": {
          "body": "var arr = steps.formulaInstance.response.body;\nvar formulaInstance2;\nvar newendtime = new Date().toISOString(); \nvar lithiumInstance;\nvar instance2name;\n\nfor(var j=0; j<arr.length; j++){\n  if(arr[j].formula.name.includes('bulk2sfdc')){\n    instance2name = arr[j].name;\n    formulaInstance2 = arr[j].id;\n    lithiumInstance = arr[j].configuration['lithiumlsw.instance.id'];\n  }\n}\n\nfor(var i=0; i<arr.length; i++){\n  if(arr[i].formula.name.includes('bulk1sfdc')){\n    config.formulainstanceid = arr[i].id;\n    done({\"formulaInstance2\": formulaInstance2, \"lastruntime\": arr[i].configuration.lastruntime, \"sfdcinstanceid\" : arr[i].configuration['sfdc.instance.id'], \"canrun\" : arr[i].configuration.canrun, \"endtime\": arr[i].configuration.endtime, \"formulainstanceid\" : arr[i].id, \"newendtime\": newendtime, \"formulaOneId\" : arr[i].formula.id, \"lithiumInstance\" : lithiumInstance, \"active\": arr[i].active, \"instance2name\": instance2name, \"instance1name\": arr[i]['name']});\n  }\n}\ndone({});"
        }
      },
      {
        "id": 99838,
        "onSuccess": [
          "bulkQuery"
        ],
        "onFailure": [],
        "name": "return-transformation",
        "type": "script",
        "properties": {
          "body": "var transformation = steps['get-transformation'].response.body.script.body;\nvar array = transformation.split(\" \");\nvar fieldArray = [];\n\nfor(var i=0; i<array.length; i++){\n\tif(array[i].startsWith('originalObject')){\n\t\tfieldArray.push(array[i].slice(15,array[i].indexOf(';')));\n\t}\n}\n\ndone({query: fieldArray.join(',')});\n"
        }
      }
    ],
    "triggers": [
      {
        "id": 17328,
        "onSuccess": [
          "canRun"
        ],
        "onFailure": [],
        "type": "scheduled",
        "async": true,
        "name": "trigger",
        "properties": {
          "cron": "0 0/1 * 1/1 * ? *"
        }
      }
    ],
    "active": true,
    "singleThreaded": false,
    "configuration": [
      {
        "id": 31947,
        "key": "canrun",
        "name": "canRun",
        "type": "value",
        "required": true
      },
      {
        "id": 31948,
        "key": "email",
        "name": "email",
        "type": "value",
        "required": true
      },
      {
        "id": 31949,
        "key": "endtime",
        "name": "endTime",
        "type": "value",
        "required": true
      },
      {
        "id": 31950,
        "key": "formulainstanceid",
        "name": "formulaInstanceId",
        "type": "value",
        "required": true
      },
      {
        "id": 31951,
        "key": "lastruntime",
        "name": "lastRunTime",
        "type": "value",
        "required": true
      },
      {
        "id": 31952,
        "key": "sfdc.instance.id",
        "name": "sfdc.instance.id",
        "type": "elementInstance",
        "required": true
      }
    ]
  }